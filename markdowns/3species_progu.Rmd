---
title: "Progressive Union"
author: "Jessica Bonnie"
date: "5/10/2022"
output: html_document
---

```{r prep, echo=FALSE,warning=FALSE,include=FALSE}

require(tidyr)
require(ggplot2)
require(data.table)
require(openssl)
require(dplyr)
require(optparse)
require(callr)
codelib<-'/home/jbonnie1/scr16_blangme2/jessica/dandd/dev-dandD/lib/'
source(file.path(codelib,'plot_progressive.R'))

outdir<-'/home/jbonnie1/scr16_blangme2/jessica/dandd/RECOMB'

```


```{bash}
tag=ecoli
outdir=/home/jbonnie1/scr16_blangme2/jessica/dandd/RECOMB/${tag}
sketchdir=/home/jbonnie1/scr16_blangme2/jessica/dandd/RECOMB/${tag}
genomedir=/home/jbonnie1/scr16_blangme2/jessica/data/${tag}

cd ${outdir}
python /home/jbonnie1/scr16_blangme2/jessica/dandd/dev-dandD/lib/dandd_cmd.py tree -s ${tag} -c ${sketchdir} -k 14 --datadir ${genomedir}

python /home/jbonnie1/scr16_blangme2/jessica/dandd/dev-dandD/lib/dandd_cmd.py tree -s ${tag} -o ${outdir} -k 14 --datadir ${genomedir} --exact

tree_pick=${outdir}/${tag}_10_dashing_dtree.pickle

python /home/jbonnie1/scr16_blangme2/jessica/dandd/dev-dandD/lib/dandd_cmd.py info -d ${tree_pick} -o ${outdir}/ksweep.csv --mink 2 --maxk 32

python /home/jbonnie1/scr16_blangme2/jessica/dandd/dev-dandD/lib/dandd_cmd.py progressive -d ${tree_pick}  -n 30 -o ${outdir}/${tag}_progu30.csv
```


```{r draw_ecoli, cache=TRUE}
tag='ecoli'
outdir='/home/jbonnie1/scr16_blangme2/jessica/dandd/RECOMB'

ksweep_ecoli <- read.csv(file.path(outdir,tag,"ksweep.csv"))

delta_ecoli<- fread(file.path(outdir,tag,paste0(tag,"_progu30.csv"))) %>%
  rename(delta_pos=delta, ngenomes=ngen)

plotProgressiveUnion(species=tag, out = outdir, delta_ecoli, nshow=5)

ggplot(ksweep_ecoli) + geom_line(aes(x=kval, y=delta_pos))

```



```{bash}
tag=salmonella
outdir=/home/jbonnie1/scr16_blangme2/jessica/dandd/RECOMB/${tag}
sketchdir=/home/jbonnie1/scr16_blangme2/jessica/dandd/RECOMB/${tag}
genomedir=/home/jbonnie1/scr16_blangme2/jessica/data/${tag}

python /home/jbonnie1/scr16_blangme2/jessica/dandd/dev-dandD/lib/dandd_cmd.py tree -s ${tag} -o ${outdir} -k 14 --datadir ${genomedir}


tree_pick=${outdir}/${tag}_10_dashing_dtree.pickle


python /home/jbonnie1/scr16_blangme2/jessica/dandd/dev-dandD/lib/dandd_cmd.py info -d ${tree_pick} -o ${outdir}/ksweep.csv --mink 2 --maxk 32

python /home/jbonnie1/scr16_blangme2/jessica/dandd/dev-dandD/lib/dandd_cmd.py progressive -d ${tree_pick}  -n 30 -o ${outdir}/${tag}_progu30.csv
```


```{r draw_salmon6, cache=TRUE}
tag='salmonella'
outdir='/home/jbonnie1/scr16_blangme2/jessica/dandd/RECOMB'

ksweep_salmon <- read.csv(file.path(outdir,tag,"ksweep.csv"))

#fread("/home/jbonnie1/scr16_blangme2/jessica/dandd/scratch/progressive_union/sketches/testplot.csv")
# delta_salmon<- fread(file.path(outdir,paste0(tag,"_progu30.csv"))) %>% select(-V1) %>% rename(delta_pos=delta)
delta_salmon<- fread(file.path(outdir,tag,paste0(tag,"_progu30.csv"))) %>%
  rename(delta_pos=delta, ngenomes=ngen)

salmon.gg<-plotProgressiveUnion(species=tag, out = outdir, delta = delta_salmon, nshow=5)
#salmon.gg + scale_y_log10()
#salmon.gg + ylim(min(c(delta_salmon$delta_pos,delta_human$delta_pos, delta_ecoli$delta_pos), na.rm=TRUE),max(c(delta_salmon$delta_pos,delta_human$delta_pos, delta_ecoli$delta_pos), na.rm=TRUE)/340)
salmon.gg

```



```{bash}
tag=human
outdir=/home/jbonnie1/scr16_blangme2/jessica/dandd/RECOMB/${tag}
sketchdir=/home/jbonnie1/scr16_blangme2/jessica/dandd/RECOMB/${tag}
genomedir=/home/jbonnie1/scr16_blangme2/jessica/data/${tag}

python /home/jbonnie1/scr16_blangme2/jessica/dandd/dev-dandD/lib/dandd_cmd.py tree -s ${tag} -o ${outdir} -k 18 --datadir ${genomedir}

tree_pick=${outdir}/${tag}_12_dashing_dtree.pickle

python /home/jbonnie1/scr16_blangme2/jessica/dandd/dev-dandD/lib/dandd_cmd.py info -d ${tree_pick} -o ${outdir}/ksweep.csv --mink 2 --maxk 32

python /home/jbonnie1/scr16_blangme2/jessica/dandd/dev-dandD/lib/dandd_cmd.py progressive -d ${tree_pick}  -n 30 -o ${outdir}/${tag}_progu30.csv
```



```{r draw_human, cache=TRUE}
tag='human'
outdir='/home/jbonnie1/scr16_blangme2/jessica/dandd/RECOMB'

ksweep_human <- read.csv(file.path(outdir,tag,"ksweep.csv"))

#fread("/home/jbonnie1/scr16_blangme2/jessica/dandd/scratch/progressive_union/sketches/testplot.csv")
# delta_salmon<- fread(file.path(outdir,paste0(tag,"_progu30.csv"))) %>% select(-V1) %>% rename(delta_pos=delta)
delta_human<- fread(file.path(outdir,tag,paste0(tag,"_progu30.csv"))) %>%
  rename(delta_pos=delta, ngenomes=ngen)


plotProgressiveUnion(species=tag, out = outdir, delta = delta_human, nshow=5)

humanprogu<-plotProgressiveUnion(species=tag, out = outdir, delta = delta_human, nshow=8) + guides(linetype = 'none')

ggsave(filename='human_progu.pdf',
       plot=humanprogu ,
       device = cairo_pdf, 
       dpi = 1200, 
       width = 16,
       height = 10, 
       units = "cm")

```






```{r humanloess}

loess_human<-loess(formula=delta_pos~ngenomes,data = delta_human)
delta_human %>% filter(delta_pos<.975*predict(loess_human,ngenomes)) %>% View()

human.dt <- delta_human %>% data.table() %>%
  group_by(ordering) %>% 
  # add column holding slope of delta from each genome to the next in an ordering
  mutate(slope = (delta_pos - lag(delta_pos)) / (ngenomes - lag(ngenomes))) %>% 
  mutate(global_mean=(max(delta_pos)-min(delta_pos))/(max(ngenomes)-min(ngenomes))) %>%
  # mutate(mean=mean(slope,na.rm = TRUE)) %>%
  filter((slope < (24/25)*global_mean | slope > (26/25)*global_mean ) & slope !=0) %>%
  #mutate(gset=list(order_human[[ordering]][1:ngenomes])) %>%
  ungroup() 
test <- unlist(lapply(seq(1,12), function(x){
  human.tmp<- human.dt %>% rowwise() %>% mutate(tmp=unlist(x %in% gset))
  return(sum(unlist(human.tmp$tmp)))
}))
test
which(test > max(test)-2)


```